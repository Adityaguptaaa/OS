<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logs - IPC Debugger</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand">üîç IPC Debugger</div>
            <ul class="navbar-menu">
                <li><a href="index.html">Home</a></li>
                <li><a href="about.html">About</a></li>
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="visualization.html">Visualization</a></li>
                <li><a href="logs.html" class="active">Logs</a></li>
                <li><a href="contact.html">Contact</a></li>
            </ul>
            <button class="theme-toggle" id="themeToggle">üåô</button>
        </div>
    </nav>

    <div class="container" style="padding-top: 2rem;">
        <div class="flex-between mb-4">
            <h1>Event Logs & Debugging</h1>
            <div class="flex gap-2">
                <button class="btn btn-secondary" id="exportJsonBtn">üì• Export JSON</button>
                <button class="btn btn-secondary" id="exportCsvBtn">üì• Export CSV</button>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="grid grid-4 gap-2">
                    <div class="form-group">
                        <label class="form-label">Severity</label>
                        <select class="form-select" id="severityFilter">
                            <option value="">All</option>
                            <option value="info">Info</option>
                            <option value="warning">Warning</option>
                            <option value="error">Error</option>
                            <option value="debug">Debug</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Event Type</label>
                        <select class="form-select" id="typeFilter">
                            <option value="">All</option>
                            <option value="process_created">Process Created</option>
                            <option value="message_sent">Message Sent</option>
                            <option value="deadlock_detected">Deadlock</option>
                            <option value="bottleneck_detected">Bottleneck</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Search</label>
                        <input type="text" class="form-input" id="searchInput" placeholder="Search logs...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-primary" id="applyFiltersBtn" style="width: 100%;">Apply Filters</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs Table -->
        <div class="card">
            <div class="card-header">Event Logs</div>
            <div class="card-body" style="padding: 0;">
                <div style="overflow-x: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Timestamp</th>
                                <th>Severity</th>
                                <th>Type</th>
                                <th>Message</th>
                                <th>Process</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody">
                            <tr>
                                <td colspan="6" class="text-center text-secondary">Loading logs...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Pagination -->
        <div class="flex-center mt-4 gap-2">
            <button class="btn btn-secondary" id="prevPageBtn" disabled>‚Üê Previous</button>
            <span id="pageInfo">Page 1</span>
            <button class="btn btn-secondary" id="nextPageBtn">Next ‚Üí</button>
        </div>
    </div>

    <footer class="footer">
        <p>&copy; 2025 IPC Debugger. Operating Systems Project.</p>
    </footer>

    <script src="js/main.js"></script>
    <script>
        (function () {
            // Logs page JavaScript - wrapped in IIFE to avoid global scope conflicts
            let currentPage = 1;
            let logs = [];
            let filteredLogs = [];

            document.addEventListener('DOMContentLoaded', () => {
                loadLogs();
                setupEventListeners();
            });

            function setupEventListeners() {
                document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
                document.getElementById('exportJsonBtn').addEventListener('click', exportJson);
                document.getElementById('exportCsvBtn').addEventListener('click', exportCsv);
                document.getElementById('searchInput').addEventListener('input', applyFilters);
            }

            async function loadLogs() {
                const simId = localStorage.getItem('currentSimulationId');
                console.log('Loading logs for simulation ID:', simId);

                if (!simId) {
                    console.warn('No simulation ID found in localStorage');
                    document.getElementById('logsTableBody').innerHTML =
                        '<tr><td colspan="6" class="text-center text-secondary">No active simulation. Please create a simulation first.</td></tr>';
                    return;
                }

                try {
                    console.log('Fetching logs from API:', `/events/${simId}?limit=1000`);
                    const response = await apiRequest(`/events/${simId}?limit=1000`);
                    console.log('API Response:', response);

                    if (response.success) {
                        logs = response.events || [];
                        filteredLogs = logs;
                        console.log(`Loaded ${logs.length} logs`);
                        renderLogs();
                    } else {
                        console.error('API returned success=false:', response);
                        document.getElementById('logsTableBody').innerHTML =
                            '<tr><td colspan="6" class="text-center text-secondary">Failed to load logs</td></tr>';
                    }
                } catch (error) {
                    console.error('Error loading logs:', error);
                    showToast('Failed to load logs: ' + error.message, 'error');
                    document.getElementById('logsTableBody').innerHTML =
                        '<tr><td colspan="6" class="text-center text-secondary">Error loading logs. Check console for details.</td></tr>';
                }
            }

            function applyFilters() {
                const severity = document.getElementById('severityFilter').value;
                const type = document.getElementById('typeFilter').value;
                const search = document.getElementById('searchInput').value.toLowerCase();

                filteredLogs = logs.filter(log => {
                    if (severity && log.severity !== severity) return false;
                    if (type && log.event_type !== type) return false;
                    if (search && !log.message.toLowerCase().includes(search)) return false;
                    return true;
                });

                currentPage = 1;
                renderLogs();
            }

            function renderLogs() {
                console.log('renderLogs called with', filteredLogs.length, 'logs');
                const tbody = document.getElementById('logsTableBody');

                if (filteredLogs.length === 0) {
                    console.log('No logs to display');
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-secondary">No logs found</td></tr>';
                    return;
                }

                const perPage = 50;
                const start = (currentPage - 1) * perPage;
                const end = start + perPage;
                const pageLogs = filteredLogs.slice(start, end);

                console.log(`Rendering ${pageLogs.length} logs (page ${currentPage})`);

                tbody.innerHTML = pageLogs.map(log => `
                <tr>
                    <td>${log.id}</td>
                    <td>${formatTimestamp(log.timestamp)}</td>
                    <td><span class="badge badge-${log.severity}">${log.severity}</span></td>
                    <td>${log.event_type}</td>
                    <td>${log.message}</td>
                    <td>${log.process_id || '-'}</td>
                </tr>
            `).join('');

                document.getElementById('pageInfo').textContent =
                    `Page ${currentPage} of ${Math.ceil(filteredLogs.length / perPage)}`;
            }

            async function exportJson() {
                const simId = localStorage.getItem('currentSimulationId');
                if (!simId) return;

                try {
                    const apiBase = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                        ? 'http://localhost:5000'
                        : 'https://os-1-8byi.onrender.com';
                    const response = await fetch(`${apiBase}/api/export/logs/${simId}?format=json`);
                    const data = await response.json();

                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `simulation_${simId}_logs.json`;
                    a.click();

                    showToast('Logs exported as JSON', 'success');
                } catch (error) {
                    showToast('Failed to export logs', 'error');
                }
            }

            async function exportCsv() {
                const simId = localStorage.getItem('currentSimulationId');
                if (!simId) return;

                try {
                    const apiBase = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                        ? 'http://localhost:5000'
                        : 'https://os-1-8byi.onrender.com';
                    const response = await fetch(`${apiBase}/api/export/logs/${simId}?format=csv`);
                    const data = await response.text();

                    const blob = new Blob([data], { type: 'text/csv' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `simulation_${simId}_logs.csv`;
                    a.click();

                    showToast('Logs exported as CSV', 'success');
                } catch (error) {
                    showToast('Failed to export logs', 'error');
                }
            }

            // Auto-refresh
            setInterval(loadLogs, 5000);
        })(); // End of IIFE
    </script>
</body>

</html>
```